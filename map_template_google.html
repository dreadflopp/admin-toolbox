<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://maps.googleapis.com/maps/api/js?key=API_KEY_PLACEHOLDER&v=3.61&loading=async&callback=initMap" async defer></script>
    <style>
        html, body, #map { width: 100%; height: 100%; margin: 0; padding: 0; }
        /* Marker label styling - text shadow for readability on map */
        .pin-label {
            text-shadow: 0 0 2px #000, 0 0 3px #000, 1px 1px 2px rgba(0,0,0,0.8);
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        let map;
        const pins = {};
        const pendingCalls = [];

        window.addPin = function(id, lat, lon, name, color, infoContent, textColor, labelOffsetX, labelOffsetY) {
            if (map) _addPin(id, lat, lon, name, color, infoContent, textColor, labelOffsetX, labelOffsetY);
            else pendingCalls.push(['add', id, lat, lon, name, color, infoContent, textColor, labelOffsetX, labelOffsetY]);
        };
        window.removePin = function(id) {
            if (map) _removePin(id);
            else pendingCalls.push(['remove', id]);
        };
        window.setPinVisible = function(id, visible) {
            if (map) _setPinVisible(id, visible);
            else pendingCalls.push(['visible', id, visible]);
        };
        window.flyToPin = function(lat, lon) {
            if (map) _flyToPin(lat, lon);
        };
        window.highlightPin = function(id) {
            if (map && typeof _highlightPin === 'function') _highlightPin(id);
        };
        window.addPolyline = function(id, path, color) {
            if (map) _addPolyline(id, path, color);
            else pendingCalls.push(['polyline', id, path, color]);
        };
        window.setPolylineVisible = function(id, visible) {
            if (map) _setPolylineVisible(id, visible);
            else pendingCalls.push(['polylineVisible', id, visible]);
        };
        window.removePolyline = function(id) {
            if (map) _removePolyline(id);
            else pendingCalls.push(['polylineRemove', id]);
        };

        function initMap() {
            const polylines = {};
            map = new google.maps.Map(document.getElementById('map'), {
                center: { lat: 57.71, lng: 11.97 },
                zoom: 12,
                mapTypeId: 'roadmap',
                tilt: 0,
                heading: 0,
                disableDefaultUI: false,
                zoomControl: true,
                mapTypeControl: true,
                scaleControl: true,
                streetViewControl: true,
                rotateControl: true,
                fullscreenControl: true,
                mapTypeControlOptions: {
                    mapTypeIds: ['satellite', 'hybrid', 'roadmap']
                }
            });

            function _contrastColor(hex) {
                if (!hex || hex.length < 7) return '#000000';
                const r = parseInt(hex.slice(1,3), 16) / 255;
                const g = parseInt(hex.slice(3,5), 16) / 255;
                const b = parseInt(hex.slice(5,7), 16) / 255;
                const lum = 0.299 * r + 0.587 * g + 0.114 * b;
                return lum < 0.5 ? '#FFFFFF' : '#000000';
            }
            function _escapeSvg(s) {
                return String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
            }
            function _addPin(id, lat, lon, name, color, infoContent, textColor, labelOffsetX, labelOffsetY) {
                color = color || '#FFFFFF';
                infoContent = infoContent || name;
                textColor = textColor || '#FFFFFF';
                labelOffsetX = labelOffsetX || 0;
                labelOffsetY = labelOffsetY || 0;
                const shortName = String(name || '').slice(0, 20);
                if (pins[id]) pins[id].setMap(null);
                const pinSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="22" height="27" viewBox="0 0 28 42">' +
                    '<path fill="' + color + '" stroke="#fff" stroke-width="2" d="M14 0C6.3 0 0 6.3 0 14c0 10.5 14 28 14 28s14-17.5 14-28C28 6.3 21.7 0 14 0z"/>' +
                    '</svg>';
                const icon = {
                    url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(pinSvg),
                    scaledSize: new google.maps.Size(22, 27),
                    anchor: new google.maps.Point(11, 27)
                };
                const marker = new google.maps.Marker({
                    position: { lat: lat, lng: lon },
                    map: map,
                    title: name,
                    icon: icon,
                    label: {
                        text: shortName,
                        color: textColor,
                        fontSize: '13px',
                        fontWeight: 'bold',
                        fontFamily: 'Segoe UI, sans-serif',
                        className: 'pin-label'
                    },
                    labelOrigin: new google.maps.Point(11 + (labelOffsetX || 0), 0 + (labelOffsetY || 0))
                });
                const infoWindow = new google.maps.InfoWindow({ content: infoContent });
                marker.addListener('click', () => {
                    window.location = 'toolbox:pin-' + id;
                    infoWindow.open(map, marker);
                    /* flyToPin/highlightPin moved to Python - prevents map pan during click
                       which could cause spurious click on another pin (e.g. default) */
                });
                pins[id] = marker;
            }
            function _removePin(id) {
                if (pins[id]) {
                    pins[id].setMap(null);
                    delete pins[id];
                }
            }
            function _setPinVisible(id, visible) {
                if (pins[id]) pins[id].setMap(visible ? map : null);
            }
            function _flyToPin(lat, lon) {
                map.panTo({ lat: lat, lng: lon });
                map.setZoom(17);
                map.setTilt(0);
            }
            function _moveToPin(lat, lon) {
                map.setTilt(0);
                const center = map.getCenter();
                if (!center) {
                    map.panTo({ lat: lat, lng: lon });
                    return;
                }
                const dLat = (lat - center.lat()) * 111;
                const dLng = (lon - center.lng()) * 111 * Math.cos(center.lat() * Math.PI / 180);
                const distKm = Math.sqrt(dLat * dLat + dLng * dLng);
                if (distKm > 50) {
                    map.setCenter({ lat: lat, lng: lon });
                } else {
                    map.panTo({ lat: lat, lng: lon });
                }
            }
            function _highlightPin(id) {
                if (pins[id]) {
                    pins[id].setAnimation(google.maps.Animation.BOUNCE);
                    setTimeout(() => { if (pins[id]) pins[id].setAnimation(null); }, 1500);
                }
            }
            function _addPolyline(id, path, color) {
                if (polylines[id]) polylines[id].setMap(null);
                if (!path || path.length < 2) return;
                const gPath = path.map(p => ({ lat: p[0], lng: p[1] }));
                const line = new google.maps.Polyline({
                    path: gPath,
                    geodesic: true,
                    strokeColor: color || '#0078d4',
                    strokeOpacity: 0.8,
                    strokeWeight: 4,
                    icons: [{
                        icon: { path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW },
                        offset: '100%',
                        repeat: '80px'
                    }],
                    map: map
                });
                polylines[id] = line;
            }
            function _setPolylineVisible(id, visible) {
                if (polylines[id]) polylines[id].setMap(visible ? map : null);
            }
            function _removePolyline(id) {
                if (polylines[id]) {
                    polylines[id].setMap(null);
                    delete polylines[id];
                }
            }

            window.addPin = function(id, lat, lon, name, color, infoContent, textColor, labelOffsetX, labelOffsetY) {
                _addPin(id, lat, lon, name, color, infoContent, textColor, labelOffsetX, labelOffsetY);
            };
            window.removePin = _removePin;
            window.setPinVisible = _setPinVisible;
            window.flyToPin = _flyToPin;
            window.moveToPin = _moveToPin;
            window.highlightPin = _highlightPin;
            window.addPolyline = function(id, path, color) { _addPolyline(id, path, color); };
            window.setPolylineVisible = _setPolylineVisible;
            window.removePolyline = _removePolyline;

            pendingCalls.forEach(function(c) {
                if (c[0] === 'add') _addPin(c[1], c[2], c[3], c[4], c[5], c[6], c[7], c[8], c[9]);
                else if (c[0] === 'remove') _removePin(c[1]);
                else if (c[0] === 'visible') _setPinVisible(c[1], c[2]);
                else if (c[0] === 'polyline') _addPolyline(c[1], c[2], c[3]);
                else if (c[0] === 'polylineVisible') _setPolylineVisible(c[1], c[2]);
                else if (c[0] === 'polylineRemove') _removePolyline(c[1]);
            });
            pendingCalls.length = 0;

            window.mapReady = true;
        }
    </script>
</body>
</html>
